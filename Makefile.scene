SCENE_NAME=scene
SCENE_SIMMAXDIR=$(MAXCOMPILER_BUILD_DIR)/$(SCENE_NAME)_$(DFEModel)_DFE_SIM/results
SCENE_DFEMAXDIR=$(MAXCOMPILER_BUILD_DIR)/$(SCENE_NAME)_$(DFEModel)_DFE/results
SCENE_SIM_MAXFILE=$(MAXCOMPILER_BUILD_DIR)/$(SCENE_NAME)_$(DFEModel)_DFE_SIM/results/$(SCENE_NAME).max
SCENE_MAXFILE=$(MAXCOMPILER_BUILD_DIR)/$(SCENE_NAME)_$(DFEModel)_DFE/results/$(SCENE_NAME).max

# ==============================
#           Simulation
# ==============================

$(SCENE_SIM_MAXFILE): $(ENGINEFILES)
	$(MAXJC) $(JFLAGS) $(ENGINEFILES)
	MAXAPPJCP='.:$(CP)' MAXSOURCEDIRS='../src' $(MAXJAVARUN) -v -m 8192 $(MANAGER) scene\
		  DFEModel=$(DFEModel) maxFileName=$(SCENE_NAME)\
		  target='DFE_SIM' enableMPCX=$(MPCX)


scene_sim.o: $(SCENE_SIM_MAXFILE)
	$(SLICCOMPILE) $< $@

scene_simc.o: ../src/scene.cpp $(SCENE_SIM_MAXFILE)
	$(CPUCOMPILER) $< $(ALL_FLAGS) -I$(MAXCOMPILER_BUILD_DIR) -I$(SCENE_SIMMAXDIR) -D__SIM__ -DDESIGN_NAME=$(SCENE_NAME) -c -o $@

scene_sim: scene_sim.o scene_simc.o mnist_sim.o feedforward_sim.o
	$(CPUCOMPILER) $(ALL_FLAGS) -o $@ $^ $(LFLAGS)

run_scene_sim: scene_sim
	$(MAXCOMPILERSIM) -n $(USER)a -c$(DEVICENUM) -d$(NUMDEVICES) restart
	SLIC_CONF+="use_simulation=$(USER)a" LD_PRELOAD=$(MAXOS_SIM) ./$< $(USER)a0:$(USER)a
	make stopsim

# ==============================
#          DFE
# ==============================

$(SCENE_MAXFILE): $(ENGINEFILES)
	$(MAXJC) $(JFLAGS) $(ENGINEFILES)
	MAXAPPJCP='.:$(CP)' MAXSOURCEDIRS='../src' $(MAXJAVARUN) -v -m 8192 $(MANAGER) le_net \
		  DFEModel=$(DFEModel) maxFileName=$(SCENE_NAME) \
		  target='DFE' enableMPCX=$(MPCX)
	cp -r $(HOME)/fpgaConvnetMaxeler \
	    $(HOME)/scene-build-backups/"build-`date +"%Y-%m-%d-%H-%M-%S"`"

scene.o: $(SCENE_MAXFILE)
	$(SLICCOMPILE) $< $@

scenec.o: ../src/scene.cpp $(SCENE_MAXFILE)
	$(CPUCOMPILER) $< $(ALL_FLAGS) -I$(MAXCOMPILER_BUILD_DIR) -I$(SCENE_DFEMAXDIR) -DDESIGN_NAME=$(SCENE_NAME) -c -o $@

scene: scene.o scenec.o mnist.o feedforward.o
	$(CPUCOMPILER) $(ALL_FLAGS) -o $@ $^ $(LFLAGS)

run_scene: scene
	SLIC_CONF="$(SLIC_CONF)" LD_PRELOAD=$(MAXOS_HW) ./$<

